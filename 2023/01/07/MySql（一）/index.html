<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>MySql（一）Mysql基础 | 春</title><meta name="author" content="zjyan"><meta name="copyright" content="zjyan"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="一、基础架构1.整体架构先看看mysql的整体架构图，如下   即主要分为三层，最上面的连接层，中间的服务层与最底层的存储引擎层 2.连接层MySQL的连接层是指位于MySQL架构中的一个组件，负责管理客户端与MySQL服务器之间的连接，它主要负责以下职责： 1）管理连接：连接层管理客户端与MySQL服务器之间的连接，包括建立、维护和断开连接。连接层能够管理连接池，使得MySQL服务器可以更有效地">
<meta property="og:type" content="article">
<meta property="og:title" content="MySql（一）Mysql基础">
<meta property="og:url" content="http://yzj.life/2023/01/07/MySql%EF%BC%88%E4%B8%80%EF%BC%89/index.html">
<meta property="og:site_name" content="春">
<meta property="og:description" content="一、基础架构1.整体架构先看看mysql的整体架构图，如下   即主要分为三层，最上面的连接层，中间的服务层与最底层的存储引擎层 2.连接层MySQL的连接层是指位于MySQL架构中的一个组件，负责管理客户端与MySQL服务器之间的连接，它主要负责以下职责： 1）管理连接：连接层管理客户端与MySQL服务器之间的连接，包括建立、维护和断开连接。连接层能够管理连接池，使得MySQL服务器可以更有效地">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://static-2w2.pages.dev/black/4.jpeg">
<meta property="article:published_time" content="2023-01-07T06:47:31.000Z">
<meta property="article:author" content="zjyan">
<meta property="article:tag" content="MySql">
<meta property="article:tag" content="数据库">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://static-2w2.pages.dev/black/4.jpeg"><link rel="shortcut icon" href="https://static-2w2.pages.dev/imgs/rabbit.png"><link rel="canonical" href="http://yzj.life/2023/01/07/MySql%EF%BC%88%E4%B8%80%EF%BC%89/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?b792d399a45da5b085a5a91cd2117f9e";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":300},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'MySql（一）Mysql基础',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-05-02 11:01:12'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><script src="https://npm.elemecdn.com/echarts@4.9.0/dist/echarts.min.js"></script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="loading-box"><div class="iron-container iron-circle"><div class="iron-box1 iron-circle iron-center"></div><div class="iron-box2 iron-circle iron-center"></div><div class="iron-box3 iron-circle iron-center"></div><div class="iron-box4 iron-circle iron-center"></div><div class="iron-box5 iron-circle iron-center"></div><div class="iron-box6 iron-circle"><div class="iron-coil" style="--i: 0"></div><div class="iron-coil" style="--i: 1"></div><div class="iron-coil" style="--i: 2"></div><div class="iron-coil" style="--i: 3"></div><div class="iron-coil" style="--i: 4"></div><div class="iron-coil" style="--i: 5"></div><div class="iron-coil" style="--i: 6"></div><div class="iron-coil" style="--i: 7"></div></div></div></div><script async="async">const preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
document.getElementById('loading-box').addEventListener('click',()=> {preloader.endLoading()})

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://static-2w2.pages.dev/imgs/cx.jpeg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">29</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">22</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> 清单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://static-2w2.pages.dev/black/4.jpeg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">春</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> 清单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">MySql（一）Mysql基础</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">发表于</span><time datetime="2023-01-07T06:47:31.000Z" title="发表于 2023-01-07 14:47:31">2023-01-07</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">6.8k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>20分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="MySql（一）Mysql基础"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="一、基础架构"><a href="#一、基础架构" class="headerlink" title="一、基础架构"></a>一、基础架构</h2><h3 id="1-整体架构"><a href="#1-整体架构" class="headerlink" title="1.整体架构"></a>1.整体架构</h3><p>先看看mysql的整体架构图，如下</p>
<img src="https://static-2w2.pages.dev/post/mysql1.png" alt="image-20230407151051373" style="zoom: 25%;" />

<p>即主要分为三层，最上面的连接层，中间的服务层与最底层的存储引擎层</p>
<h3 id="2-连接层"><a href="#2-连接层" class="headerlink" title="2.连接层"></a>2.连接层</h3><p>MySQL的连接层是指位于MySQL架构中的一个组件，负责管理客户端与MySQL服务器之间的连接，它主要负责以下职责：</p>
<p>1）<strong>管理连接</strong>：连接层管理客户端与MySQL服务器之间的连接，包括建立、维护和断开连接。连接层能够管理连接池，使得MySQL服务器可以更有效地处理连接请求。</p>
<p>2）<strong>安全性</strong>：连接层可以提供安全性功能，如SSL&#x2F;TLS协议和数据加密，以确保连接的安全性。这是特别重要的，因为MySQL通常用于存储敏感信息，如用户密码和财务数据。</p>
<p>3）<strong>协议处理</strong>：连接层能够处理多种协议，如TCP&#x2F;IP、Unix套接字等，以适应不同的操作系统和网络环境。</p>
<h3 id="3-服务层"><a href="#3-服务层" class="headerlink" title="3.服务层"></a>3.服务层</h3><h4 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h4><p>mysql的服务层缓存主要包括三个部分：查询缓存、InnoDB缓存和键值缓存</p>
<p>1）<strong>查询缓存</strong></p>
<p>最早的缓存机制，只能匹配完全匹配的sql查询语句，语句稍变就无法匹配</p>
<p>而且存在表更新操作会清除查询缓存，缓存占用内存过大等问题</p>
<p>因此在MySQL8.0版本中，已经废弃了查询缓存</p>
<p>2）<strong>InnoDB缓存</strong></p>
<p>InnoDB缓存是InnoDB存储引擎中使用的缓存，它存储<strong>表和索引</strong>数据，用于加速查询和数据操作</p>
<p>InnoDB缓存使用LRU算法进行缓存管理，可以根据需要调整缓存大小，以满足不同的应用需求</p>
<p>3）<strong>键值缓存</strong></p>
<p>键值缓存是MySQL 8中新加入的功能，它是一个基于Redis协议的缓存服务，支持主从架构和高可用性，用于存储短期缓存数据，如会话信息、配置信息等</p>
<h4 id="解析器"><a href="#解析器" class="headerlink" title="解析器"></a>解析器</h4><blockquote>
<p>主要工作是将SQL语句解析成MySQL服务器内部的数据结构</p>
</blockquote>
<p><strong>1）语法分析</strong></p>
<p>对SQL语句进行语法检查，确保语句符合MySQL的语法规范</p>
<p><strong>2）语义分析</strong></p>
<p>对SQL语句进行语义检查，确保语句中使用的数据库、表、列等存在，以及是否具有正确的权限</p>
<p><strong>3）转换SQL语句</strong></p>
<p>将SQL语句转换成MySQL服务器内部的数据结构，方便后续的查询优化、执行计划生成等操作</p>
<p>简单点想，可以认为是将sql语句生成了一颗解析树，方便后续生成<strong>执行计划</strong></p>
<h4 id="优化器"><a href="#优化器" class="headerlink" title="优化器"></a>优化器</h4><p>负责对SQL查询进行优化，选择最优的执行计划</p>
<p>怎么理解上面这句话呢？下面看看优化器具体的职责吧</p>
<ul>
<li><strong>查询重写</strong>：优化器会根据查询语句的特点，对查询进行重写，以便更好地进行优化。</li>
<li><strong>执行计划生成</strong>：优化器会生成多个可能的执行计划，并对这些执行计划进行成本估算，选择成本最小的执行计划作为最终的执行计划。</li>
<li><strong>索引选择</strong>：优化器会根据查询语句的条件，选择最优的索引，以便更快地查询数据。</li>
<li><strong>连接顺序选择</strong>：优化器会根据表的大小、索引使用情况等因素，选择最优的连接顺序，以便更快地连接多个表。</li>
<li><strong>其他优化</strong>：优化器还会根据查询语句的特点，进行其他的优化操作，比如子查询展开、常量合并、条件推导等</li>
</ul>
<p>由此可见，一条sql，在优化器这里可能会生成多个执行计划，但是经过一系列代价计算步骤之后，优化器选择出一条它认为代价最小的执行计划作为最终的执行计划</p>
<blockquote>
<p>这也是很多慢sql出现的原因，即优化器经过优化后选择了自己认为最优的执行计划，但是实际上和开发者所预期的执行步骤不相符，也并不是最优的</p>
</blockquote>
<h4 id="执行器"><a href="#执行器" class="headerlink" title="执行器"></a>执行器</h4><p>负责执行SQL语句，将查询结果返回给客户端</p>
<p>它还负责连接、认证、锁及事务管理等，不是重点，不再赘述</p>
<h4 id="4-存储引擎层"><a href="#4-存储引擎层" class="headerlink" title="4.存储引擎层"></a>4.存储引擎层</h4><p>是实际上执行sql语句，并负责将数据存储在磁盘上，提供对数据的读写操作的最终执行部分</p>
<p>最常见的存储引擎有innoDB、myisam和memory</p>
<p><strong>1）InnoDB</strong></p>
<p>InnoDB是MySQL默认的事务型存储引擎，支持<strong>事务</strong>、<strong>行级锁</strong>和<strong>外键</strong>约束等高级特性</p>
<ul>
<li><p>支持事务和行级锁：InnoDB是一个支持事务和行级锁的存储引擎，可以提供高并发和数据安全性</p>
</li>
<li><p>支持外键约束：InnoDB支持外键约束，可以保证数据的完整性和一致性</p>
</li>
<li><p>适合高并发场景：由于支持事务和行级锁，因此InnoDB适合高并发场景，可以提供高效的并发访问</p>
</li>
</ul>
<p><strong>2）MyISAM存储引擎</strong></p>
<p>MyISAM是MySQL早期版本的默认存储引擎，<strong>不支持事务和行级锁</strong>，但具有快速的读取和写入性能，适合于一些非事务性应用场景</p>
<ul>
<li>支持全文索引：MyISAM支持全文索引，适合需要进行全文搜索的应用场景。</li>
<li>适合读取频繁的应用场景：由于具有快速的读取和写入性能，因此MyISAM适合读取频繁的应用场景，如日志记录等。</li>
</ul>
<p><strong>3）Memory存储引擎</strong></p>
<p>Memory是一种将数据存储在内存中的存储引擎，适用于临时表和缓存等应用场景</p>
<ul>
<li>存储在内存中：Memory存储引擎将数据存储在内存中，因此具有快速的读写性能。</li>
<li>不支持持久化存储：由于数据存储在内存中，因此Memory存储引擎不支持持久化存储。</li>
<li>适合临时数据和缓存：Memory存储引擎适合存储临时数据和缓存，如存储用户登录状态等</li>
</ul>
<blockquote>
<p>后面讲到索引，事务及锁的时候，都会再度比较这三个存储引擎的不同表现，此处不再进行更详细比较</p>
</blockquote>
<h3 id="5-Innodb"><a href="#5-Innodb" class="headerlink" title="5.Innodb"></a>5.Innodb</h3><h4 id="1）思考"><a href="#1）思考" class="headerlink" title="1）思考"></a><strong>1）思考</strong></h4><p>首先思考一个问题，那就是对于InnoDB存储引擎来说，数据是放在磁盘上的，那么每次对数据进行操作，InnoDB都要去磁盘上寻找数据吗？是不是每次操作多少数据，InnoDB就从磁盘加载多少数据使用呢？</p>
<p>这很明显不可能，因为磁盘的随机寻址速度是很慢的，那面对这种情况，根据计算机常用的策略，肯定要加缓存了</p>
<p>事实上，InnoDB确实采用了缓冲池的设计理念，配合预读取的思路，在每次对数据操作时，会先去缓冲池中寻找，找不到再去磁盘读取，而且根据局部性原理，会多读取一部分到缓冲池里，这样当相邻数据被操作时，也能够快速在缓冲池中寻找到</p>
<p>这也就是InnoDb所谓的<strong>Buffer Pool</strong>与<strong>预读取</strong>了</p>
<h4 id="2）数据页"><a href="#2）数据页" class="headerlink" title="2）数据页"></a><strong>2）数据页</strong></h4><p>在操作系统上，也存在预读取理念与设计，在数据存储的时候，操作系统将4KB数据划分为一页；而在InnoDB里，一页的大小则被划分为16KB，读取的时候就是按页读取的</p>
<p>在InnoDB的设计中，一次读取会将相邻的8页数据都读取到缓存里，这样是为了避免频繁访问磁盘，从而提升mysql速率；这个8页可以通过参数配置修改，但是不建议改的过大，原因也很简单，这是要占用内存的，缓冲池就那么大，一次读太多页进去可能很快就满了</p>
<h4 id="3）数据写入"><a href="#3）数据写入" class="headerlink" title="3）数据写入"></a><strong>3）数据写入</strong></h4><p>缓冲池不仅负责读取，在写入时也是先写入到缓冲池，再统一向磁盘进行写入，内存中与磁盘中页数据不一致的被称为脏页，那脏页何时写回磁盘呢？</p>
<p>还是前面提到的问题，如果每个修改都直接向磁盘写入，会导致磁盘每次都要随机寻址，导致写入效率低下，降低吞吐量，因此不如先存到缓存里，待系统没那么繁忙时再写回磁盘</p>
<p>这里写入的是缓冲池里一个称为Change Buffer的地方，属于Buffer Pool一部分</p>
<blockquote>
<p>到这里也能看出了，Buffer Pool的存在就是为了增加读与写的速度，提高吞吐量</p>
</blockquote>
<h4 id="4）Redo-Log"><a href="#4）Redo-Log" class="headerlink" title="4）Redo Log"></a><strong>4）Redo Log</strong></h4><p>上面将修改的数据暂时存到了内存里，等待到达<strong>某一条件</strong>时统一写入磁盘，这样就会存在一个类似redis持久化时的问题—&gt;还没写到磁盘，服务挂了怎么办？</p>
<p>因此，mysql采用了Redo Log日志来解决这个问题</p>
<p>Redo log中记录的是修改操作的<strong>物理数据</strong>，包括修改的数据库页、偏移量、修改前的数据、修改后的数据等信息。这些记录可以用来重做在数据文件上的操作，以保证数据库的一致性和完整性</p>
<p>这里就又有个问题了，日志肯定也要进行持久化，也就是意味着也要和磁盘进行io操作，那和直接把数据修改写入磁盘有什么区别？</p>
<ul>
<li><strong>数据量</strong>：redo log记录的只是对物理数据的操作动作，并没有去操作，所以它的数据量是很小的，也就说明它的写入操作是比直接操作数据要快</li>
<li><strong>顺序IO</strong>：redo log的写入是顺序IO写入，一次寻址即可，而直接操作数据是随机寻址，会慢很多</li>
</ul>
<p>此外，只有在redo log写入磁盘成功后才会触发数据到磁盘的修改操作</p>
<p>而且redo log也有自己的缓冲池，称为<strong>Redo log buffer</strong>，这是为了防止频繁io导致的上下文切换，统一将redo log写入磁盘</p>
<p>Redo log带来磁盘写入速度提升的同时，也带来了数据丢失与数据不一致的风险</p>
<p><strong>数据不一致</strong>：redo log中数据持久化成功了，还没来得及将修改持久化到磁盘，系统就挂了；这种情况很好解决，只要redo log写成功了，机器重启后会再读取redo log进行数据的同步</p>
<p><strong>数据丢失</strong>：这是由于redo log也采用了缓冲池技术带来的隐患</p>
<p>写入时机是什么时候呢？</p>
<p>在配置文件中有一个参数innodb_change_buffer_max_size可以控制，默认是1，即每次事务提交都会将log buffer 写入磁盘</p>
<h4 id="5）Undo-Log"><a href="#5）Undo-Log" class="headerlink" title="5）Undo Log"></a><strong>5）Undo Log</strong></h4><p>Undo log记录了事务发生之前的数据状态，这样如果数据的修改过程出现了异常，可以根据undo log来进行数据的回滚操作</p>
<p>有了Undo Log之后，这里看一下以下更新语句会执行哪些步骤</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">update user set name = &#x27;zhangsan&#x27; where id = 1;</span><br></pre></td></tr></table></figure>

<ul>
<li>事务开始，从内存或磁盘取到包含这条数据的数据页，返回给server层的执行器</li>
<li>server层的执行器修改数据页的这一行数据为zhangsan</li>
<li>记录name&#x3D;zhangsan到undo log</li>
<li>记录name&#x3D;zhangsan到redo log</li>
<li>调用存储引擎接口，记录数据页到Buffer Pool（修改name&#x3D;zhangsan）</li>
<li>事务提交</li>
</ul>
<h4 id="6）整体架构图"><a href="#6）整体架构图" class="headerlink" title="6）整体架构图"></a><strong>6）整体架构图</strong></h4><p>了解了上面的知识后，看一下innodb整体架构图</p>
<img src="https://static-2w2.pages.dev/post/innodb.png" alt="Innodb 逻辑存储结构 – EPHUIZI HOME" style="zoom: 67%;" />

<p>左边即上面说的缓冲部分，可见有Buffer Pool、Change Buffer和Log Buffer</p>
<p>既然是缓冲，那么就存在缓冲池满了的情况，那么在InnoDB中，缓冲池满了怎么处理呢？</p>
<p>在redis之中，内存淘汰策略有六七种，详情见<a href="https://yzj.life/2023/04/04/redis%E8%AF%A6%E8%A7%A3/#2-%E6%B7%98%E6%B1%B0%E7%AD%96%E7%95%A5">redis淘汰策略</a></p>
<p>在InnoDB之中，内存淘汰策略采用的是变种的LRU策略，分为了young和old区域</p>
<blockquote>
<p>这里的区域划分和JVM中的不一样，注意区分</p>
</blockquote>
<h4 id="7）LRU"><a href="#7）LRU" class="headerlink" title="7）LRU"></a><strong>7）LRU</strong></h4><p>正常的LRU是采用数组+双向链表来实现的</p>
<p>在InnoDB里面则采用了一个叫LRU List的结果来实现LRU，里面存储的是指向数据页的指针，并不存储真正的数据页</p>
<p>上面有提到过InnoDB的预读取机制，即一次并不只是读取需要的数据页，而是读取多个相邻的数据页，那么如果读取到的相邻数据页其实没什么用呢？如何淘汰这些使用频率不高的数据页呢？</p>
<p>LRU list采用了冷热分离的策略来实现淘汰，即把LRU list分成两部分，靠近head的地方叫做new sublist，用来存放数据，也就是热区；靠近tail的地方称为old sublist，也就是冷区；中间使用midpoint分割，如下图</p>
<img src="https://static-2w2.pages.dev/post/bofferpool.png" alt="img" style="zoom:67%;" />

<p>执行流程：</p>
<ul>
<li>所有新数据加入到buffer pool的时候，一律先放到冷数据区的head，不区分预读还是普通读</li>
<li>因此如果有些预读数据后面没用到，会在old sublist区直接被淘汰</li>
<li>而放到LRU list之后，如果再次访问，就被移到热区的head<ul>
<li>为了防止热区数据被污染，只有在1s内再次访问的才能移到热区</li>
</ul>
</li>
<li>如果热区数据长时间没被访问，就会先移动到冷区的head部，最后慢慢移动到tail淘汰</li>
</ul>
<p>此外还有很多优化操作，这里不再讨论</p>
<h4 id="8）双写缓冲"><a href="#8）双写缓冲" class="headerlink" title="8）双写缓冲"></a><strong>8）双写缓冲</strong></h4><p>由于InnoDB是16KB一页，而操作系统是4KB一页，那么在写入一半的时候，系统挂了怎么办？由于这时候是写入的页被损坏了，redo log无法恢复这种数据</p>
<p>双写缓冲就是解决这个情况的，它设置了一个双写缓冲区，在将数据写入磁盘之前会先写入到这里，待这里写入成功了再向磁盘写入，这样即使磁盘写入出错，也可以利用双写缓冲区进行数据恢复</p>
<h4 id="9）binlog"><a href="#9）binlog" class="headerlink" title="9）binlog"></a><strong>9）binlog</strong></h4><p>在 MySQL 中，Binlog（Binary Log）是一种二进制日志格式，用于记录数据库的所有修改操作。它记录了所有的 DML（数据操作语言）和 DDL（数据定义语言）语句，包括 INSERT、UPDATE、DELETE、CREATE、ALTER 等操作。</p>
<p>Binlog 有两个主要的作用：</p>
<ul>
<li>数据恢复：当出现数据丢失或者其他意外情况时，可以使用 Binlog 进行数据恢复。通过 replay binlog 的方式，可以重放所有的修改操作，以恢复到丢失数据之前的状态。</li>
<li>数据复制：Binlog 也是 MySQL 实现主从复制的核心组件之一。主库将修改操作写入 Binlog，从库通过读取 Binlog 并重放这些操作，以保持与主库的数据同步。</li>
</ul>
<p>在 MySQL 中，可以通过配置 binlog_format 参数来设置 Binlog 的格式，主要有以下两种：</p>
<ul>
<li>STATEMENT：记录 SQL 语句本身，对于相同的语句可以减少 Binlog 的大小，但是可能会出现不一致的情况，比如 UUID() 函数、NOW() 函数等在从库和主库执行的结果不一致。</li>
<li>ROW：记录 SQL 语句执行后的行数据变更，相对于 STATEMENT 格式，Binlog 的大小会更大，但是可以保证从库的数据与主库完全一致。同时，ROW 格式也可以避免因为 SQL 语句执行时出现的隐式转换等问题导致的不一致</li>
</ul>
<h2 id="二、索引"><a href="#二、索引" class="headerlink" title="二、索引"></a>二、索引</h2><h3 id="1-引言"><a href="#1-引言" class="headerlink" title="1.引言"></a>1.引言</h3><p>索引是一种数据结构，用于提高数据库的查询效率</p>
<p>索引可以看作是对数据库中的某个列或多个列的值进行排序和分组的数据结构，它可以帮助数据库系统快速地定位到符合查询条件的数据行，从而提高查询的速度</p>
<p>常见的有B+树索引，哈希索引和全文索引</p>
<p><strong>B+树索引</strong>：最常见，支持范围查询，排序和分组等操作</p>
<p><strong>哈希索引</strong>：适合等值查询</p>
<p><strong>全文索引</strong>：适合文本数据的全文搜索</p>
<h3 id="2-索引类型"><a href="#2-索引类型" class="headerlink" title="2.索引类型"></a>2.索引类型</h3><p>在创建索引时，会选择索引类型，那么不同类型的索引，都有什么性质呢？</p>
<p>在InnoDB里面，索引有三种类型</p>
<ul>
<li><strong>普通索引</strong>：普通索引没有唯一性限制，可重复</li>
<li><strong>唯一索引</strong>：不能有重复的值，可为空<ul>
<li>主键索引是特殊的唯一索引，不允许有空值</li>
</ul>
</li>
<li><strong>全文索引</strong>：用于文本类型数据全文检索</li>
</ul>
<p>此外，索引还可以分为聚簇索引和非聚簇索引</p>
<ul>
<li><strong>聚簇索引</strong>：将表的数据存储和索引存储在一起<ul>
<li>每张表唯一</li>
<li>一般默认主键索引作为唯一索引</li>
</ul>
</li>
<li><strong>非聚簇索引</strong>：包括普通索引，唯一索引，全文索引等，用于加速查找</li>
</ul>
<blockquote>
<p>关于聚簇索引后面还会详细分析，这里不再讨论</p>
</blockquote>
<h3 id="3-B-树"><a href="#3-B-树" class="headerlink" title="3.B+树"></a>3.B+树</h3><p>在InnoDB中，采用的是B+树来构造索引，但是它经常被拿来问与B树的区别，那就先来看下B树的结构</p>
<img src="https://static-2w2.pages.dev/post/B.png" alt="image-20230407210607863" style="zoom: 33%;" />

<p>由上图可以看出来，B树的非叶子节点也会进行数据的存储，并且叶子节点是独立的，下面分析下它的优劣</p>
<p>优点：</p>
<ul>
<li>减少IO：相比二叉树，B树每个节点分出的叉更多，因此可以保证更低的IO次数查询到数据，从而提高磁盘读写效率</li>
<li>性能稳定：高度较低，遍历层数较少，从而性能稳定</li>
<li>支持动态扩容：可在数据增加时自动调整结构</li>
</ul>
<p>缺点：</p>
<ul>
<li>维护成本高</li>
<li>插入和删除相对较慢</li>
</ul>
<p>尽管B树的表现已经很优秀了，但是还是存在一些问题的，下面看下B+树的结构</p>
<img src="https://static-2w2.pages.dev/post/B+.png" alt="B+树" style="zoom:33%;" />



<p>由图可知，B+树的叶子节点使用双向链表连接在一起，因此支持范围查询</p>
<p>B+树的非叶子节点仅存储索引数据，因此每个非叶子节点处都能存储更多的索引数据</p>
<p>对比B树如下：</p>
<ul>
<li>更少的IO：B+树每个非叶子节点仅存储索引数据，因此可以放下更多的子节点，整体上能够使得B+树的高度更低，从而较少IO，提升查询效率</li>
<li>更适合范围查询：B+树的叶子节点使用双向链表串联在一起，因此更适合范围查询</li>
<li>更适合高并发插入：B树的所有数据都存储在叶子节点上，因此对于插入操作来说，只需要更新叶子节点上的链表即可，不需要更新非叶子节点，从而减少锁的粒度，提高并发性能</li>
</ul>
<h3 id="4-索引落地"><a href="#4-索引落地" class="headerlink" title="4.索引落地"></a>4.索引落地</h3><p>此处仅对比InnoDB和MyISAM中的索引实现</p>
<h4 id="1）MyISAM"><a href="#1）MyISAM" class="headerlink" title="1）MyISAM"></a><strong>1）MyISAM</strong></h4><p>它其中有两个文件，分别是.MYD和.MYI文件</p>
<p>.MYD：数据文件，存放数据记录</p>
<p>.MYI：索引文件，存放索引</p>
<p>那么如何根据索引找到数据呢？</p>
<p>MyISAM的B+树，叶子节点存储的是数据文件对应的磁盘记录，然后到数据文件里面获取数据</p>
<h4 id="2）InnoDB"><a href="#2）InnoDB" class="headerlink" title="2）InnoDB"></a><strong>2）InnoDB</strong></h4><p>与MyISAM不同的是，InnoDB的叶子节点里面直接存储了数据</p>
<p>所以有个说法，即在InnoDB里面<strong>索引即数据，数据即索引</strong>，就是这个意思</p>
<p>这里就有个问题出现了，索引那么多，数据存在哪个索引的叶子节点呢？</p>
<ul>
<li><p><strong>聚簇索引</strong>：在InnoDB中，聚簇索引就是<strong>索引键值</strong>的<strong>逻辑</strong>顺序跟<strong>表数据行</strong>的<strong>物理</strong>存储数据是一致的</p>
</li>
<li><p><strong>非聚簇索引&#x2F;二级索引：</strong>InnoDB之中，不是聚簇索引的索引，都是非聚簇索引</p>
</li>
</ul>
<p>而在InnoDB之中，为了防止每次更新索引后都要更新所有的索引叶子节点，所以只在聚簇索引的叶子节点之中存储了真正的数据值，而其他二级索引的叶子节点都是指向聚簇索引的叶子节点</p>
<p>哪些索引能称为聚簇索引呢？</p>
<ul>
<li><strong>主键索引</strong>：当表中存在主键索引时，主键索引就是聚簇索引</li>
<li><strong>唯一索引</strong>：如果没有定义主键，那么InnoDB会选择第一个不包含NULL值的唯一索引作为主键索引<ul>
<li>不包含NULL值也是主键索引和唯一索引的最明显区别</li>
</ul>
</li>
<li><strong>隐藏列</strong>：如果上面两者都没有，那么InnoDB就会创建一个6字节长的ROWID列作为隐藏的聚集索引，它是随着行记录的写入而递增的</li>
</ul>
<blockquote>
<p>回表查询</p>
<p>相比主键索引成为的聚簇索引，二级索引叶子节点存储的往往是主键的id值，因此使用二级索引查找数据时，需要再根据id值走一遍主键索引，这就是所谓的<strong>回表查询</strong></p>
</blockquote>
<h3 id="5-索引使用原则"><a href="#5-索引使用原则" class="headerlink" title="5.索引使用原则"></a>5.索引使用原则</h3><p>什么样的数据列适合建立索引呢？</p>
<h4 id="1）离散度"><a href="#1）离散度" class="headerlink" title="1）离散度"></a><strong>1）离散度</strong></h4><p>离散度公式：</p>
<p>count(distinct(column_name))&#x2F;count(*)</p>
<p>即去重后数据&#x2F;总数据行</p>
<p>离散度越大越适合创建索引</p>
<h4 id="2）联合索引最左匹配"><a href="#2）联合索引最左匹配" class="headerlink" title="2）联合索引最左匹配"></a><strong>2）联合索引最左匹配</strong></h4><p>所谓联合索引，即使用多个数据列创建一个索引</p>
<p>联合索引生效的前提是要按照创建联合索引的顺序，从左向右匹配才能使得索引生效</p>
<p><strong>最左匹配原则：</strong>最左匹配原则是指，在一个联合索引（复合索引）中，如果查询条件涉及到联合索引的多个列，那么查询时应该优先使用联合索引的最左边的列。</p>
<p>例如，对于联合索引 (a, b, c)，如果查询条件中包含 a、b、c 三个列，那么应该以 a 作为第一关键字进行匹配，只有在 a 相等的情况下，才会去匹配 b，以此类推。如果查询条件只包含 b、c 两个列，那么联合索引就无法使用。</p>
<h4 id="3）覆盖索引"><a href="#3）覆盖索引" class="headerlink" title="3）覆盖索引"></a><strong>3）覆盖索引</strong></h4><p>覆盖索引指的是在查询语句中，可以直接通过索引来获取所需的数据，而不必访问数据表。具体来说，如果一个查询涉及的列都在同一个索引中，那么这个索引就是一个覆盖索引。</p>
<p>使用覆盖索引的好处是可以减少查询所需的 IO 操作和 CPU 计算，从而提高查询性能。因为不需要访问数据表，所以查询所需的时间和资源就会更少。</p>
<p>在使用覆盖索引时，需要注意以下几点：</p>
<ul>
<li>索引要包含所有需要查询的列，而且要尽量少地包含其他列，因为不需要的列会增加索引的大小，导致查询性能降低</li>
<li>使用 SELECT * 或 SELECT col1, col2 … 语句时，不能使用覆盖索引，因为这些语句需要返回表中所有列的值</li>
<li>覆盖索引对于频繁更新、插入或删除的表来说，并不是最优的选择，因为每次操作都需要更新索引</li>
</ul>
<h4 id="4）索引下推（ICP）"><a href="#4）索引下推（ICP）" class="headerlink" title="4）索引下推（ICP）"></a><strong>4）索引下推（ICP）</strong></h4><p>索引下推（Index Condition Pushdown，简称ICP）是MySQL查询优化器的一项优化技术，用于减少查询所需的IO操作，提高查询性能</p>
<p>在传统的查询中，MySQL会首先根据索引查找到满足条件的数据行，然后再从磁盘中读取这些数据行的其他列，最后再进行筛选和聚合等操作。这个过程中，需要进行大量的磁盘IO操作，耗费大量的时间和资源</p>
<p>而索引下推则是将筛选和聚合等操作尽可能地推到索引层进行处理，避免了不必要的磁盘IO操作，从而提高了查询性能。具体来说，MySQL查询优化器会根据查询条件，判断哪些条件可以直接在索引上进行计算，哪些条件需要在数据行中计算。然后，MySQL会将可以在索引上计算的条件转化为对应的索引扫描条件，以减少数据行的读取，提高查询效率</p>
<p>说人话，<strong>就是把过滤的动作交给存储引擎做完，而不是在服务层过滤</strong></p>
<p>ICP默认开启</p>
<p>举个例子，假如有联合索引(last_name,fast_name)</p>
<p>执行以下查询语句</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> employees <span class="keyword">where</span> last_name <span class="operator">=</span> <span class="string">&#x27;wang&#x27;</span> <span class="keyword">and</span> first_name <span class="keyword">like</span> <span class="string">&#x27;%zi&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>这个语句如何执行呢？</p>
<p>第一种查询方式</p>
<ul>
<li>假如根据联合索引查出所有姓wang的二级索引数据三个主键值：6，7，8</li>
<li>回表，到主键索引上查询所有符合条件的数据</li>
<li>把这3条数据返回给server层，在server层过滤出以zi结尾的名字</li>
</ul>
<p>这种方式存在问题，此时是只用到了wang这个索引，查到3条数据给server层，然后再在server层进行过滤%zi，获得最后两条数据，那假如wang过滤出来1000w条数据，实际上%zi只有一条数据符合呢？这个任务都交给server层是很不合理的</p>
<p>第二种查询方式</p>
<ul>
<li>根据联合索引查出所有姓wang的二级索引数据：3个索引</li>
<li>然后从二级索引中筛选出所有first_name以zi结尾的索引—1个索引，id为8</li>
<li>然后回表查询，到主键上找所有符合条件的数据返回</li>
</ul>
<p>很明显，第二种查询方式效果更好，而这也就是所谓的索引下推</p>
<h3 id="6-索引的创建与使用"><a href="#6-索引的创建与使用" class="headerlink" title="6.索引的创建与使用"></a>6.索引的创建与使用</h3><p>索引创建需要遵循一定的原则，而不是可以随意创建的，因为随着数据结构的变更，维护索引也需要成本的</p>
<p>以下是一些创建索引尽量遵循的原则</p>
<ul>
<li>在用于where判断order排序和join的on，group by的字段上创建索引</li>
<li>索引的个数不要太多</li>
<li>过长的字段，使用前缀索引</li>
<li>区分度太低的字段，不要建立索引，例如性别</li>
<li>频繁更新的值不要建立索引<ul>
<li>可能导致页分裂</li>
</ul>
</li>
<li>随机无序的值，不建议作为索引，如身份证<ul>
<li>无序，分裂</li>
</ul>
</li>
<li>组合索引把散列度高的放在前面</li>
<li>创建复合索引，而不是修改单列索引</li>
</ul>
<h3 id="7-索引失效"><a href="#7-索引失效" class="headerlink" title="7.索引失效"></a>7.索引失效</h3><p>那么什么时候建立的索引使用不到呢？</p>
<p>索引失效多是因为一些操作导致结果不确定，从而无法使用索引</p>
<ul>
<li>索引列上使用函数和表达式，逻辑运算符进行计算</li>
<li>字符串不加引号，出现了隐式转换</li>
<li>like前面用了%</li>
<li>负向查询<ul>
<li>如NOT LIKE</li>
</ul>
</li>
<li>‘!&#x3D; ‘和 ‘&lt;&gt;’还有’NOT IN’这三者在某些情况下可以<ul>
<li>跟数据库版本，数据量，数据选择度都有关系</li>
</ul>
</li>
</ul>
<p>其实，是否使用索引，最终都是由优化器决定</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://yzj.life">zjyan</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://yzj.life/2023/01/07/MySql%EF%BC%88%E4%B8%80%EF%BC%89/">http://yzj.life/2023/01/07/MySql%EF%BC%88%E4%B8%80%EF%BC%89/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://yzj.life" target="_blank">春</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/MySql/">MySql</a><a class="post-meta__tags" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a></div><div class="post_share"><div class="social-share" data-image="https://static-2w2.pages.dev/black/4.jpeg" data-sites="wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/01/17/MySql%EF%BC%88%E4%BA%8C%EF%BC%89/"><img class="prev-cover" src="https://static-2w2.pages.dev/black/8.jpeg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">MySql（二）MySql事务与锁</div></div></a></div><div class="next-post pull-right"><a href="/2022/12/02/Java%E8%BF%9B%E9%98%B6%E4%B9%8B%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%EF%BC%88%E4%B8%83%EF%BC%89/"><img class="next-cover" src="https://static-2w2.pages.dev/black/5.jpeg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Java进阶之并发编程（七）ThreadPoolExecutor</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2023/01/17/MySql%EF%BC%88%E4%BA%8C%EF%BC%89/" title="MySql（二）MySql事务与锁"><img class="cover" src="https://static-2w2.pages.dev/black/8.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-01-17</div><div class="title">MySql（二）MySql事务与锁</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="giscus-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://static-2w2.pages.dev/imgs/cx.jpeg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">zjyan</div><div class="author-info__description">爱我所爱，尽我所能</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">29</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">22</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/zhijie-yan"><i class="fab fa-github"></i><span>欢迎交流～</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://space.bilibili.com/304087712" target="_blank" title="Bilibili"><i class="fab fa-bilibili"></i></a><a class="social-icon" href="mailto:yan1255015228@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content"><center>我想你一定很忙<br>所以<br>只看前三个字就好了<br></center></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E5%9F%BA%E7%A1%80%E6%9E%B6%E6%9E%84"><span class="toc-text">一、基础架构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84"><span class="toc-text">1.整体架构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E8%BF%9E%E6%8E%A5%E5%B1%82"><span class="toc-text">2.连接层</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%9C%8D%E5%8A%A1%E5%B1%82"><span class="toc-text">3.服务层</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%93%E5%AD%98"><span class="toc-text">缓存</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%A3%E6%9E%90%E5%99%A8"><span class="toc-text">解析器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%98%E5%8C%96%E5%99%A8"><span class="toc-text">优化器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E5%99%A8"><span class="toc-text">执行器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E%E5%B1%82"><span class="toc-text">4.存储引擎层</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-Innodb"><span class="toc-text">5.Innodb</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%EF%BC%89%E6%80%9D%E8%80%83"><span class="toc-text">1）思考</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%EF%BC%89%E6%95%B0%E6%8D%AE%E9%A1%B5"><span class="toc-text">2）数据页</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3%EF%BC%89%E6%95%B0%E6%8D%AE%E5%86%99%E5%85%A5"><span class="toc-text">3）数据写入</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4%EF%BC%89Redo-Log"><span class="toc-text">4）Redo Log</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5%EF%BC%89Undo-Log"><span class="toc-text">5）Undo Log</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6%EF%BC%89%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84%E5%9B%BE"><span class="toc-text">6）整体架构图</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7%EF%BC%89LRU"><span class="toc-text">7）LRU</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8%EF%BC%89%E5%8F%8C%E5%86%99%E7%BC%93%E5%86%B2"><span class="toc-text">8）双写缓冲</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#9%EF%BC%89binlog"><span class="toc-text">9）binlog</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E7%B4%A2%E5%BC%95"><span class="toc-text">二、索引</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%BC%95%E8%A8%80"><span class="toc-text">1.引言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E7%B4%A2%E5%BC%95%E7%B1%BB%E5%9E%8B"><span class="toc-text">2.索引类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-B-%E6%A0%91"><span class="toc-text">3.B+树</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E7%B4%A2%E5%BC%95%E8%90%BD%E5%9C%B0"><span class="toc-text">4.索引落地</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%EF%BC%89MyISAM"><span class="toc-text">1）MyISAM</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%EF%BC%89InnoDB"><span class="toc-text">2）InnoDB</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E7%B4%A2%E5%BC%95%E4%BD%BF%E7%94%A8%E5%8E%9F%E5%88%99"><span class="toc-text">5.索引使用原则</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%EF%BC%89%E7%A6%BB%E6%95%A3%E5%BA%A6"><span class="toc-text">1）离散度</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%EF%BC%89%E8%81%94%E5%90%88%E7%B4%A2%E5%BC%95%E6%9C%80%E5%B7%A6%E5%8C%B9%E9%85%8D"><span class="toc-text">2）联合索引最左匹配</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3%EF%BC%89%E8%A6%86%E7%9B%96%E7%B4%A2%E5%BC%95"><span class="toc-text">3）覆盖索引</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4%EF%BC%89%E7%B4%A2%E5%BC%95%E4%B8%8B%E6%8E%A8%EF%BC%88ICP%EF%BC%89"><span class="toc-text">4）索引下推（ICP）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-%E7%B4%A2%E5%BC%95%E7%9A%84%E5%88%9B%E5%BB%BA%E4%B8%8E%E4%BD%BF%E7%94%A8"><span class="toc-text">6.索引的创建与使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-%E7%B4%A2%E5%BC%95%E5%A4%B1%E6%95%88"><span class="toc-text">7.索引失效</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/04/20/MyBatis%E8%A7%A3%E6%9E%90%EF%BC%88%E4%B8%80%EF%BC%89/" title="MyBatis解析（一）"><img src="https://static-2w2.pages.dev/black/6.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="MyBatis解析（一）"/></a><div class="content"><a class="title" href="/2023/04/20/MyBatis%E8%A7%A3%E6%9E%90%EF%BC%88%E4%B8%80%EF%BC%89/" title="MyBatis解析（一）">MyBatis解析（一）</a><time datetime="2023-04-20T07:46:49.000Z" title="发表于 2023-04-20 15:46:49">2023-04-20</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/04/16/MQ%E5%AF%B9%E6%AF%94/" title="MQ比较"><img src="https://static-2w2.pages.dev/black/4.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="MQ比较"/></a><div class="content"><a class="title" href="/2023/04/16/MQ%E5%AF%B9%E6%AF%94/" title="MQ比较">MQ比较</a><time datetime="2023-04-16T10:29:05.000Z" title="发表于 2023-04-16 18:29:05">2023-04-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/04/08/Netty/" title="Netty（一）netty基础"><img src="https://static-2w2.pages.dev/black/5.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Netty（一）netty基础"/></a><div class="content"><a class="title" href="/2023/04/08/Netty/" title="Netty（一）netty基础">Netty（一）netty基础</a><time datetime="2023-04-08T11:45:46.000Z" title="发表于 2023-04-08 19:45:46">2023-04-08</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/04/04/MQ%E4%B9%8BKafka/" title="消息中间件之Kafka"><img src="https://static-2w2.pages.dev/black/8.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="消息中间件之Kafka"/></a><div class="content"><a class="title" href="/2023/04/04/MQ%E4%B9%8BKafka/" title="消息中间件之Kafka">消息中间件之Kafka</a><time datetime="2023-04-04T11:45:59.000Z" title="发表于 2023-04-04 19:45:59">2023-04-04</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/04/03/MQ%E4%B9%8BRocketMQ/" title="消息中间件之RocketMQ"><img src="https://static-2w2.pages.dev/black/9.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="消息中间件之RocketMQ"/></a><div class="content"><a class="title" href="/2023/04/03/MQ%E4%B9%8BRocketMQ/" title="消息中间件之RocketMQ">消息中间件之RocketMQ</a><time datetime="2023-04-03T11:45:46.000Z" title="发表于 2023-04-03 19:45:46">2023-04-03</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://static-2w2.pages.dev/black/4.jpeg')"><div id="footer-wrap"><div class="copyright">&copy;2022 - 2023 By zjyan</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>function loadGiscus () {
  let nowTheme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'light'

  const config = Object.assign({
    src: 'https://giscus.app/client.js',
    'data-repo': 'zhijie-yan/Giscus',
    'data-repo-id': 'R_kgDOJSiR1Q',
    'data-category-id': 'DIC_kwDOJSiR1c4CVhQv',
    'data-mapping': 'pathname',
    'data-theme': nowTheme,
    'data-reactions-enabled': '1',
    crossorigin: 'anonymous',
    async: true
  },null)

  let ele = document.createElement('script')
  for (let key in config) {
    ele.setAttribute(key, config[key])
  }
  document.getElementById('giscus-wrap').insertAdjacentElement('afterbegin',ele)
}

function changeGiscusTheme () {
  const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'light'

  function sendMessage(message) {
    const iframe = document.querySelector('iframe.giscus-frame');
    if (!iframe) return;
    iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
  }

  sendMessage({
    setConfig: {
      theme: theme
    }
  });
}

if ('Giscus' === 'Giscus' || !false) {
  if (false) btf.loadComment(document.getElementById('giscus-wrap'), loadGiscus)
  else loadGiscus()
} else {
  function loadOtherComment () {
    loadGiscus()
  }
}</script></div><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["link[rel=\"canonical\"]","meta[property=\"og:image\"]","meta[property=\"og:title\"]","meta[property=\"og:url\"]","head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/wanko.model.json"},"display":{"position":"laft","width":150,"height":300},"mobile":{"show":true},"algolia":{"indexName":"hexo","applicationID":"T31GFL5LNX","apiKey":"180a4925ad0cc4ca01c1efcbe8b6ec59","fields":["title","content","url"],"debug":false,"concurrent":2},"log":false});</script></body></html>