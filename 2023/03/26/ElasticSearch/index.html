<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>ElasticSearch | 春</title><meta name="author" content="zjyan"><meta name="copyright" content="zjyan"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="一、引言1.什么是搜索？概念：搜索是指使用计算机程序在互联网或本地计算机存储的数据中查找特定信息的过程 即输入关键字，获取想要结果的过程 搜索涉及的种类十分繁杂，包括新闻网页搜索、站内搜索（垂直搜索）等 2.如何实现搜索2.1 传统数据库传统MySql数据库能否实现搜索功能呢？答案是肯定的 但是传统MySql数据库实现搜索只能适用数据量小，简单搜索的场景，具有以下弊端  存储问题：电商网站商品上亿">
<meta property="og:type" content="article">
<meta property="og:title" content="ElasticSearch">
<meta property="og:url" content="http://yzj.life/2023/03/26/ElasticSearch/index.html">
<meta property="og:site_name" content="春">
<meta property="og:description" content="一、引言1.什么是搜索？概念：搜索是指使用计算机程序在互联网或本地计算机存储的数据中查找特定信息的过程 即输入关键字，获取想要结果的过程 搜索涉及的种类十分繁杂，包括新闻网页搜索、站内搜索（垂直搜索）等 2.如何实现搜索2.1 传统数据库传统MySql数据库能否实现搜索功能呢？答案是肯定的 但是传统MySql数据库实现搜索只能适用数据量小，简单搜索的场景，具有以下弊端  存储问题：电商网站商品上亿">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://static-2w2.pages.dev/black/9.jpeg">
<meta property="article:published_time" content="2023-03-26T01:40:06.000Z">
<meta property="article:author" content="zjyan">
<meta property="article:tag" content="ElasticSearch">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://static-2w2.pages.dev/black/9.jpeg"><link rel="shortcut icon" href="https://static-2w2.pages.dev/imgs/rabbit.png"><link rel="canonical" href="http://yzj.life/2023/03/26/ElasticSearch/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?b792d399a45da5b085a5a91cd2117f9e";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":300},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'ElasticSearch',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-04-15 21:47:08'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><script src="https://npm.elemecdn.com/echarts@4.9.0/dist/echarts.min.js"></script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="loading-box"><div class="iron-container iron-circle"><div class="iron-box1 iron-circle iron-center"></div><div class="iron-box2 iron-circle iron-center"></div><div class="iron-box3 iron-circle iron-center"></div><div class="iron-box4 iron-circle iron-center"></div><div class="iron-box5 iron-circle iron-center"></div><div class="iron-box6 iron-circle"><div class="iron-coil" style="--i: 0"></div><div class="iron-coil" style="--i: 1"></div><div class="iron-coil" style="--i: 2"></div><div class="iron-coil" style="--i: 3"></div><div class="iron-coil" style="--i: 4"></div><div class="iron-coil" style="--i: 5"></div><div class="iron-coil" style="--i: 6"></div><div class="iron-coil" style="--i: 7"></div></div></div></div><script async="async">const preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
document.getElementById('loading-box').addEventListener('click',()=> {preloader.endLoading()})

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://static-2w2.pages.dev/imgs/cx.jpeg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">25</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">19</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> 清单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://static-2w2.pages.dev/black/9.jpeg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">春</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> 清单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">ElasticSearch</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">发表于</span><time datetime="2023-03-26T01:40:06.000Z" title="发表于 2023-03-26 09:40:06">2023-03-26</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/">分布式</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">7.4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>23分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="ElasticSearch"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="一、引言"><a href="#一、引言" class="headerlink" title="一、引言"></a>一、引言</h2><h3 id="1-什么是搜索？"><a href="#1-什么是搜索？" class="headerlink" title="1.什么是搜索？"></a>1.什么是搜索？</h3><p>概念：搜索是指使用计算机程序在互联网或本地计算机存储的数据中查找特定信息的过程</p>
<p>即输入关键字，获取想要结果的过程</p>
<p>搜索涉及的种类十分繁杂，包括新闻网页搜索、站内搜索（垂直搜索）等</p>
<h3 id="2-如何实现搜索"><a href="#2-如何实现搜索" class="headerlink" title="2.如何实现搜索"></a>2.如何实现搜索</h3><h4 id="2-1-传统数据库"><a href="#2-1-传统数据库" class="headerlink" title="2.1 传统数据库"></a>2.1 传统数据库</h4><p>传统MySql数据库能否实现搜索功能呢？答案是肯定的</p>
<p>但是传统MySql数据库实现搜索只能适用<strong>数据量小，简单搜索</strong>的场景，具有以下弊端</p>
<ul>
<li><strong>存储问题：</strong>电商网站商品上亿条时，涉及到单表数据过大必须拆分表，数据库磁盘占用过大必须分库 (mycat)</li>
<li><strong>性能问题：</strong>解决上面问题后，查询“笔记本电脑”等关键词时，上亿条数据的商品名字段逐行扫描，性能跟不上</li>
<li><strong>不能分词：</strong>如搜索“笔记本电脑”，只能搜索完全和关键词一样的数据，那么数据量小时，搜索“笔记本电脑”，“电脑”数据要不要给用户</li>
</ul>
<h4 id="2-2-全文检索与倒排索引"><a href="#2-2-全文检索与倒排索引" class="headerlink" title="2.2 全文检索与倒排索引"></a>2.2 全文检索与倒排索引</h4><p>在MySql中，其实也支持全文检索，主要依赖于MySql的全文索引来实现，是一种用于快速搜索文本数据的索引技术，MySQL 5.6及以上版本支持全文索引</p>
<p>全文索引会将指定的列中的文本数据进行分词，去除停用词等处理，生成一个词汇表，将每个词汇与出现该词汇的行进行关联，从而加速文本数据的搜索，需要注意的是，MySQL的全文索引实现是基于<strong>倒排索引</strong>（Inverted Index）的</p>
<p>何谓倒排索引呢？简单点说就是，以词作为key，出现位置的集合作为value的结构</p>
<p>举个例子，见下表</p>
<table>
<thead>
<tr>
<th align="center">ID</th>
<th align="center">Name</th>
</tr>
</thead>
<tbody><tr>
<td align="center">1</td>
<td align="center">课程周边帽子</td>
</tr>
<tr>
<td align="center">2</td>
<td align="center">课程周边衣服</td>
</tr>
<tr>
<td align="center">3</td>
<td align="center">课程书籍XXX</td>
</tr>
<tr>
<td align="center">4</td>
<td align="center">杰伦签名</td>
</tr>
</tbody></table>
<p>那么在对Name列分词，按照倒排索引就可以得到下面的表格</p>
<table>
<thead>
<tr>
<th align="center">分词term</th>
<th align="center">IDs</th>
</tr>
</thead>
<tbody><tr>
<td align="center">课程</td>
<td align="center">[1,2,3]</td>
</tr>
<tr>
<td align="center">周边</td>
<td align="center">[1,2]</td>
</tr>
<tr>
<td align="center">书籍</td>
<td align="center">[3]</td>
</tr>
<tr>
<td align="center">杰伦</td>
<td align="center">[4]</td>
</tr>
<tr>
<td align="center">…</td>
<td align="center">…</td>
</tr>
</tbody></table>
<p>由此可见，如果用户输入一个关键词后，能够快速的匹配到分词，从而找到分词出现的位置</p>
<p>倒排索引源于实际应用中需要根据属性的值来查找记录。这种索引表中的每一项都包括一个属性值和具有该属性值的各记录的地址。由于不是由记录来确定属性值，而是由属性值来确定记录的位置，因而称为倒排索引(inverted index)。带有倒排索引的文件我们称为倒排索引文件，简称倒排文件(inverted fifile)</p>
<h4 id="2-3-Lucene"><a href="#2-3-Lucene" class="headerlink" title="2.3 Lucene"></a>2.3 Lucene</h4><p>Lucene是一个非常强大和灵活的全文搜索引擎库，能够广泛应用于各种文本搜索场景，包括网站搜索、企业搜索、电子商务、新闻检索等</p>
<p>简单点说，就是一个jar包，里面封装了全文检索的引擎、搜索的算法代码。开发时，引入lucen的jar包，通过api 开发搜索相关业务。底层会在磁盘建立索引库</p>
<h2 id="二、概念介绍"><a href="#二、概念介绍" class="headerlink" title="二、概念介绍"></a>二、概念介绍</h2><h3 id="1-简介"><a href="#1-简介" class="headerlink" title="1.简介"></a>1.简介</h3><p><strong>Elasticsearch（ES）是基于Lucene构建的分布式搜索引擎，它扩展了Lucene的功能并提供了大规模数据处理、实时搜索、多租户等特性。因此，可以说ES是Lucene的一个扩展和增强版</strong></p>
<p>ES在Lucene的基础上提供了以下特性：</p>
<ul>
<li>分布式架构：ES具有分布式的数据存储和处理能力，可以实现数据分片、节点扩展和高可用等功能</li>
<li>RESTful API：ES使用基于HTTP协议的RESTful API，可以方便地与其他应用程序和工具进行交互</li>
<li>实时搜索：ES能够在数据发生变化时实时更新索引，提供实时搜索的能力</li>
<li>多租户支持：ES支持多租户模式，可以在同一个ES集群中隔离多个应用的数据和搜索请求</li>
<li>多种查询方式：ES支持多种查询方式，包括全文搜索、精确查询、过滤查询等</li>
</ul>
<p>上面介绍的是ES的特性，主要是说ES更加适合大型分布式系统，那么它到底具有哪些功能呢？下面介绍</p>
<ul>
<li>分布式的<strong>搜索引擎</strong>和<strong>数据分析引擎</strong><ul>
<li>搜索:互联网搜索、电商网站站内搜索、OA系统查询 </li>
<li>数据分析:电商网站查询近一周哪些品类的图书销售前十;新闻网站，最近3天阅读量最高的十个</li>
<li>关键词，舆情分析。</li>
</ul>
</li>
<li><strong>全文检索，结构化检索，数据分析</strong><ul>
<li>全文检索:搜索商品名称包含java的图书<ul>
<li>select * from books where book_name like “%java%”。</li>
</ul>
</li>
<li>结构化检索:搜索商品分类为spring的图书都有哪些<ul>
<li>select * from books where category_id&#x3D;’spring’</li>
</ul>
</li>
<li>数据分析:分析每一个分类下有多少种图书<ul>
<li>select category_id,count(*) from books group by category_id</li>
</ul>
</li>
</ul>
</li>
<li><strong>对海量数据进行近实时的处理</strong><ul>
<li>分布式:ES自动可以将海量数据分散到多台服务器上去存储和检索，进行并行查询，提高搜索效 率。相对的，Lucene是单机应用。</li>
<li>近实时:数据库上亿条数据查询，搜索一次耗时几个小时，是批处理(batch-processing)。而es 只需秒级即可查询海量数据，所以叫近实时。秒级</li>
</ul>
</li>
</ul>
<blockquote>
<p>简单来说，就是搜索、分析、分布式和近实时</p>
</blockquote>
<h3 id="2-适用场景"><a href="#2-适用场景" class="headerlink" title="2.适用场景"></a>2.适用场景</h3><p>Elasticsearch（ES）是一个强大的搜索引擎，具有广泛的应用场景，包括但不限于以下几个方面：</p>
<ul>
<li><strong>企业搜索</strong>：ES能够处理海量的企业数据，包括文本、图片、视频等类型的数据，能够提供高效、准确的搜索结果。企业搜索场景包括了员工信息搜索、文档搜索、知识库搜索等。</li>
<li><strong>日志分析</strong>：ES能够对大量的日志数据进行处理和分析，提取关键信息，帮助企业监测业务运营和系统性能。日志分析场景包括了网络日志、系统日志、应用程序日志等。</li>
<li><strong>电商搜索</strong>：ES能够处理商品信息和用户搜索请求，提供高效、准确的搜索结果。电商搜索场景包括了商品搜索、推荐引擎等。</li>
<li><strong>网站搜索</strong>：ES能够处理网站上的信息和用户搜索请求，提供高效、准确的搜索结果。网站搜索场景包括了新闻搜索、博客搜索、社交网络搜索等。</li>
<li><strong>实时监控</strong>：ES能够实时处理数据，包括日志、事件、传感器数据等，可以在实时监控场景中应用。实时监控场景包括了网络监控、物联网监控等。</li>
</ul>
<blockquote>
<p>主要场景还是搜索</p>
</blockquote>
<h3 id="3-特点"><a href="#3-特点" class="headerlink" title="3.特点"></a>3.特点</h3><ul>
<li><strong>高可用性</strong>：ES是一个分布式系统，支持多个节点的部署和自动容错，因此具有高可用性。即使其中某些节点发生故障，系统依然能够正常运行。</li>
<li><strong>多种数据源支持</strong>：ES支持多种类型的数据源，包括关系型数据库、文档、日志、传感器数据等，因此适用于各种数据分析场景。</li>
<li><strong>实时搜索和分析</strong>：ES能够在数据发生变化时实时更新索引，提供实时搜索和分析的能力。</li>
<li><strong>多种查询方式</strong>：ES支持多种查询方式，包括全文搜索、精确查询、过滤查询等，满足不同的搜索需求。</li>
<li><strong>可扩展性</strong>：ES具有高度可扩展性，可以根据业务需求动态扩展节点和数据存储容量。</li>
<li><strong>灵活的部署方式</strong>：ES可以在云端或本地环境中部署，支持多种操作系统和编程语言，因此非常灵活</li>
</ul>
<blockquote>
<p>可拓展、高可用、功能强大、部署简单</p>
</blockquote>
<h3 id="4-核心概念"><a href="#4-核心概念" class="headerlink" title="4.核心概念"></a>4.核心概念</h3><h4 id="4-1-NRT-Near-Realtime-近实时"><a href="#4-1-NRT-Near-Realtime-近实时" class="headerlink" title="4.1 NRT(Near Realtime):近实时"></a>4.1 NRT(Near Realtime):近实时</h4><p>两方面:</p>
<ul>
<li>写入数据时，过1秒才会被搜索到，因为内部在分词、录入索引</li>
<li>es搜索时:搜索和分析数据需要秒级出结果</li>
</ul>
<h4 id="4-2-Cluster-集群"><a href="#4-2-Cluster-集群" class="headerlink" title="4.2 Cluster:集群"></a>4.2 Cluster:集群</h4><p>包含一个或多个启动着es实例的机器群，通常一台机器起一个es实例，同一网络下，集名一样的多个es实例自动组成集群，自动均衡分片等行为，默认集群名为“elasticsearch”</p>
<h4 id="4-3-Node-节点"><a href="#4-3-Node-节点" class="headerlink" title="4.3 Node:节点"></a>4.3 Node:节点</h4><p>Node是一个单独的ES实例，可以是单独的服务器或虚拟机</p>
<p>每个Node可以参与一个或多个Cluster，并负责处理Cluster中的数据和请求</p>
<p>Node可以承载多个Index，每个Index可以包含多个Shard</p>
<p>节点名自动分配，也可以手动配置</p>
<h4 id="4-4-Index-索引"><a href="#4-4-Index-索引" class="headerlink" title="4.4 Index:索引"></a>4.4 Index:索引</h4><p>Index是ES中最高层级的数据容器，类似于关系型数据库中的Database</p>
<p>每个Index都有自己的Mapping和Settings，可以存储多个Document，并且可以被分成多个Shard，每个Shard可以分配到不同的Node上</p>
<p>索引创建规则如下</p>
<ul>
<li><strong>索引名称</strong>：索引名称必须是小写字母，不能包含大写字母或下划线，只能包含字母、数字、连字符和点号</li>
<li><strong>分片和副本</strong>：创建索引时需要指定分片和副本的数量。分片数量应该根据数据量、查询频率和硬件资源进行调整，以保证索引的性能。副本数量可以提高索引的可用性和容错能力</li>
<li><strong>Mapping：</strong>Mapping用于定义索引中的文档结构，包括字段类型、分析器、数据格式等。合理地定义Mapping可以提高搜索和分析的性能</li>
<li><strong>设置</strong>：设置包括索引级别和节点级别的设置。索引级别的设置包括分片和副本、Mapping、刷新间隔、缓存等。节点级别的设置包括JVM堆内存、文件描述符、线程池等</li>
<li><strong>索引别名</strong>：索引别名是索引的可读名称，可以用于在查询时指定具体的索引。索引别名可以随时更改，可以将多个索引合并成一个别名</li>
</ul>
<p>总的来说，ES索引创建的规则包括索引名称、分片和副本、Mapping、设置和索引别名等</p>
<h4 id="4-5-Document-文档"><a href="#4-5-Document-文档" class="headerlink" title="4.5 Document:文档"></a>4.5 Document:文档</h4><p>es中的最小数据单元。一个document就像数据库中的一条记录。通常以json格式显示。多个 document存储于一个索引(Index)中</p>
<p>例如:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">book document</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;book_id&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line"><span class="string">&quot;book_name&quot;</span>: <span class="string">&quot;carl的笔记&quot;</span>,</span><br><span class="line"><span class="string">&quot;book_desc&quot;</span>: <span class="string">&quot;carl呕心沥血写的菜谱，一定要好好研习&quot;</span>, </span><br><span class="line"><span class="string">&quot;category_id&quot;</span>: <span class="string">&quot;2&quot;</span>,</span><br><span class="line"><span class="string">&quot;category_name&quot;</span>: <span class="string">&quot;java&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-6-Field-字段"><a href="#4-6-Field-字段" class="headerlink" title="4.6 Field:字段"></a>4.6 Field:字段</h4><p>Field是Document中的属性，类似于关系型数据库中的列</p>
<p>Field可以是不同的数据类型，如字符串、数字、日期、布尔等</p>
<h4 id="4-7-Type-类型"><a href="#4-7-Type-类型" class="headerlink" title="4.7 Type:类型"></a>4.7 Type:类型</h4><p>在早期的ES版本中，Type是指在一个Index中对数据进行分组的方式，类似于关系型数据库中的表</p>
<p><strong>分析: 为什么要7.X版本去除Type?</strong><br>因为关系型数据库比非关系型数据库的概念提出的早，而且很成熟，应用广泛。所以，后来很多 NoSQL(包括:MongoDB，Elasticsearch等)都参考并延用了传统关系型数据库的基本概念。由于需要有一个对应关系型数据库表的概念，所以type应运而生。那么为什么我们又需要把type去除呢?并且 需要在7.X版本去除呢?<br>首先，我们可以看一下ES的版本演变。<br>在 5.X 版本中，一个 index 下可以创建多个 type;<br>在 6.X 版本中，一个 index下只能存在一个 type;<br>在7.X 版本中，直接去除了 type 的概念，就是说index 不再会有 type。<br><strong>原因分析:</strong><br><strong>为何要去除 type 的概念?</strong><br>答: 因为 Elasticsearch 设计初期，是直接查考了关系型数据库的设计模式，存在了 type(数据表)的概念<br>但是，其搜索引擎是基于 Lucene 的，这种 “基因”决定了 type 是多余的。 Lucene 的全文检索功能之所以快，是因为<strong>倒序索引</strong>的存在。而这种<strong>倒序索引</strong>的生成是基于 index 的，而并非 type。多个type 反 而会减慢搜索的速度。</p>
<p>为了保持 Elasticsearch “<strong>一切为了搜索</strong>” 的宗旨，适当的做些改变(去除 type)也是无可厚非的，也是 值得的。</p>
<p><strong>为何不是在 6.X 版本开始就直接去除 type，而是要逐步去除type?</strong></p>
<p>答:因为历史原因，前期 Elasticsearch 支持一个 index 下存在多个 type的，而且，有很多项目在使用 Elasticsearch 作为数据库。如果直接去除 type 的概念，不仅是很多应用 Elasticsearch 的项目将面临 业务、功能和代码的大改，而且对于 Elasticsearch 官方来说，也是一个巨大的挑战(这个是伤筋动骨 的大手术，很多涉及到 type源码是要修改的)。</p>
<p>所以，权衡利弊，采取逐步过渡的方式，最终，推迟到 7.X 版本才完成 “去除 type” 这个 革命性的变革</p>
<h4 id="4-8-shard-分片"><a href="#4-8-shard-分片" class="headerlink" title="4.8 shard:分片"></a>4.8 shard:分片</h4><p>index数据过大时，将index里面的数据，分为多个shard，分布式的存储在各个服务器上面。可以支持海量数据和高并发，提升性能和吞吐量，充分利用多台机器的cpu</p>
<h4 id="4-9-replica-副本"><a href="#4-9-replica-副本" class="headerlink" title="4.9 replica:副本"></a>4.9 replica:副本</h4><p>在分布式环境下，任何一台机器都会随时宕机，如果宕机，index的一个分片没有，导致此index不能搜索。所以，为了保证数据的安全，我们会将每个index的分片进行备份，存储在另外的机器上。保证少数机器宕机es集群仍可以搜索。能正常提供查询和插入的分片我们叫做主分片(primary shard)，其 余的我们就管他们叫做备份的分片(replica shard)</p>
<h4 id="4-10-Mapping-映射"><a href="#4-10-Mapping-映射" class="headerlink" title="4.10 Mapping:映射"></a>4.10 Mapping:映射</h4><p>Mapping用于定义Index中的Document结构，包括Field名称、Field类型、分析器、数据格式等。Mapping的定义可以影响搜索和分析的性能。</p>
<h4 id="4-11-对比"><a href="#4-11-对比" class="headerlink" title="4.11 对比"></a>4.11 对比</h4><table>
<thead>
<tr>
<th>关系型数据库(比如Mysql)</th>
<th>非关系型数据库(Elasticsearch)</th>
</tr>
</thead>
<tbody><tr>
<td>数据库Database</td>
<td>索引Index</td>
</tr>
<tr>
<td>表Table</td>
<td>索引Index(原为Type)</td>
</tr>
<tr>
<td>数据行Row</td>
<td>文档Document</td>
</tr>
<tr>
<td>数据列Column</td>
<td>字段Field</td>
</tr>
<tr>
<td>约束 Schema</td>
<td>映射Mapping</td>
</tr>
</tbody></table>
<h2 id="三、核心原理"><a href="#三、核心原理" class="headerlink" title="三、核心原理"></a>三、核心原理</h2><h3 id="1-文件存储"><a href="#1-文件存储" class="headerlink" title="1.文件存储"></a>1.文件存储</h3><p>对应上面介绍的Document概念</p>
<p>ES是一个文档型数据库，在其中，一条数据就是一个文档，Json格式作为保存形式</p>
<p>将ES与MySql相关术语对应描述一条数据如下</p>
<p>一个 Elasticsearch 集群可以包含多个索引(数据库)，也就是说其中包含了很多类型(表)。这些类型中包含了很多的文档(行)，然后每个文档中又包含了很多的字段(列)</p>
<p>Elasticsearch的交互，可以使用 JavaAPI，也可以直接使用HTTP的Restful API方式</p>
<h3 id="2-倒排表与分类索引"><a href="#2-倒排表与分类索引" class="headerlink" title="2.倒排表与分类索引"></a>2.倒排表与分类索引</h3><p>在上面的介绍中，可以知道在ES中索引对应数据库中的dataBase</p>
<p>上面4.4介绍过索引的简历规则，这里不再赘述</p>
<p>那么在ES中，索引是以什么结构存在的呢？先别急，先看个例子，引入一下概念</p>
<p>假设有三条结构化数据，存储在MySql中，如下所示</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">|ID  |Name    |Age    | Sex   | </span><br><span class="line">| -- |:------:| -----:| -----:| </span><br><span class="line">|1   |张三     |18     |Female </span><br><span class="line">|2   |李四     |50     |Male</span><br><span class="line">|3   |王五     |18     |Male</span><br></pre></td></tr></table></figure>

<p>那么这些数据，在ES当中是如何存储的呢？</p>
<p>首先是Name</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">| Term | Posting List |</span><br><span class="line">| -- |:----:|</span><br><span class="line">|张三 |	1	| </span><br><span class="line">|李四 |	2	| </span><br><span class="line">|王五 |	3	|</span><br></pre></td></tr></table></figure>

<p>Age</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">| Term | Posting List |</span><br><span class="line">| -- |:----:	|</span><br><span class="line">| 50 | 2 			|</span><br><span class="line">| 18 | [1,3]  |</span><br></pre></td></tr></table></figure>

<p>Sex</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">| Term   | Posting List |</span><br><span class="line">| -- 	   |	  :----:    |</span><br><span class="line">| Female |      1       |</span><br><span class="line">| Male   |    [2,3]     |</span><br></pre></td></tr></table></figure>

<p>可以观察到，上面出现了两个列概念Term和Posting List</p>
<ul>
<li><strong>Term：分类索引</strong><ul>
<li>分类索引则是按照文档的主题或类别来建立索引的数据结构</li>
</ul>
</li>
<li><strong>Posting List：倒排表</strong><ul>
<li>倒排表是根据文档中的单词或词语来建立索引的数据结构</li>
</ul>
</li>
</ul>
<blockquote>
<p>分类索引就是上面的分别根据Name，Age和Sex建立索引</p>
<p>倒排表就是每个分类索引里面实现的<strong>分词-ids</strong>的结构</p>
</blockquote>
<p>从上面的结构，可以论证之前说的，在ES中，倒排索引使用分词作为key，将key出现在的文档id集合作为values，这就是简化的索引结构</p>
<p>但是像MySql会出现的数据量过大问题一样，当上面的倒排表中，数据量过大怎么办？此时遍历扫描查询效率必然会受到极大的限制</p>
<h3 id="3-Term-Dictionary-词典"><a href="#3-Term-Dictionary-词典" class="headerlink" title="3.Term Dictionary(词典)"></a>3.<strong>Term Dictionary(词典)</strong></h3><p>在ES中，每个字段Field都有自己的一个词典结构，用于快速查找当中的term值</p>
<p>那么词典到底是什么呢？</p>
<p>就像上面的Name列，词典存储的就是”张三”、”李四”和”王五”这三个词条</p>
<p>除了词条本身，词典还会存储一些元数据信息，比如每个词条出现的文档频率（Document Frequency），即包含该词条的文档数目，以及倒排索引中的位置信息等</p>
<p>词典的具体实现方式由ES来决定，可选择哈希表、红黑树等数据结构</p>
<h3 id="4-Term-Index-词典索引）"><a href="#4-Term-Index-词典索引）" class="headerlink" title="4.Term Index(词典索引）"></a>4.<strong>Term Index(词典索引）</strong></h3><p>很明显，仅有词典还是不够的，因为当数据量上来之后，使用词典还是要全表扫描来找到词term，再去倒排表中找文档id，因此会考虑到去用索引结构加速term的查询</p>
<p>Term Index(词典索引）就是这个作用</p>
<p>那么如何实现词典索引呢？</p>
<p>主要分为基于树形的索引和基于哈希表的索引，此处主要介绍树形词典索引</p>
<img src="https://static-2w2.pages.dev/post/es-dict-index.png" alt="image-20230411135933867" style="zoom:50%;" />

<p>索引树实现如上，它本质上是一颗前缀树，在树的节点中会存储词典的偏移量，从偏移量位置向后遍历，下面看一下他们的整体结构</p>
<img src="https://static-2w2.pages.dev/post/es-dic.png" alt="image-20230411151457452" style="zoom:50%;" />

<p>用户查询时，先利用词典索引去词典中定位，再根据词典去倒排表中找到文档id</p>
<p>词典和倒排表可以存在内存中，也可以存储在磁盘中，上述样例是词典和倒排表都基于磁盘的存储，因为全部放在内存可能会占用空间过多</p>
<p>查找流程如下：</p>
<ul>
<li>用户输入c，根据词典索引，找到c，根据c上的偏移量offset找到词典位置</li>
<li>读取词典carl，找到对应的倒排表中的位置，从而查出来对应的文档编码</li>
</ul>
<p>为了加快访问速度，可以使词典索引存储在内存中，但是词典索引都放在内存中又会占用太多的空间，如何优化这个问题呢？</p>
<h3 id="5-FST"><a href="#5-FST" class="headerlink" title="5.FST"></a>5.FST</h3><p>FST，全称为finite state transducer，是一种有限状态自动机（finite state machine）的数据结构</p>
<p>FST 的基本思想是将一个有限状态自动机编码为一个紧凑的数据结构，并将其存储在内存中，以支持快速的查找和匹配操作。在 FST 中，每个状态都对应着一个整数编号，每个状态都可以转移到另一个状态，转移的过程可以使用一个字符或一组字符来触发。在实际的应用中，FST 还可以扩展为支持权重或成本，以支持更复杂的匹配操作</p>
<p>简单点说，FST就是用来<strong>压缩词典索引</strong>的，下面通过一个案例介绍FST实现思想</p>
<p>假设有以下字段和序号映射关系：</p>
<table>
<thead>
<tr>
<th align="center">字段</th>
<th align="center">序号</th>
</tr>
</thead>
<tbody><tr>
<td align="center">mop</td>
<td align="center">0</td>
</tr>
<tr>
<td align="center">moth</td>
<td align="center">1</td>
</tr>
<tr>
<td align="center">pop</td>
<td align="center">2</td>
</tr>
<tr>
<td align="center">star</td>
<td align="center">3</td>
</tr>
<tr>
<td align="center">stop</td>
<td align="center">4</td>
</tr>
<tr>
<td align="center">top</td>
<td align="center">5</td>
</tr>
</tbody></table>
<p>很明显，用Map结构可以存储这些对应关系，那么能不能对他们进行压缩，从而使用更少的空间来存储呢？</p>
<img src="https://static-2w2.pages.dev/post/es-fst.png" alt="image-20230411153455762" style="zoom:50%;" />

<p>上图中，将单词拆分成单个字母，通过⭕和–&gt;表示出来</p>
<p>在–&gt;上，不显示表示权重为0</p>
<p>如果⭕后面出现分支，就标记权重，最后整条路径上的权重加起来就是这个单词对应的序号</p>
<p>例如stop，id就是3+0+1+0&#x3D;4</p>
<p>但是这个树并不会包含所有的term，而是很多term的前缀，通过这些前缀快速定位到这个前缀所属的磁盘的block，再从这个block去找文档列表</p>
<p>为了压缩词典的空间，实际上每个block都只会保存block 内不同的部分，比如 mop 和 moth 在同一个以 mo 开头的block，那么在对应的词典里面只会保存 p 和th ，这样空间利用率提高了一倍</p>
<p>早期的ES模糊查询使用编辑距离来计算，使用FST之后将模糊查询效率提升了100倍以上</p>
<p>现在词典索引已经被压缩，可以通过词典索引+词典找到倒排表位置，文档肯定是存储在磁盘上的，但是倒排表就直接原样放到磁盘上吗？这样会不会占用大量磁盘空间？</p>
<p>假如1亿个文档，每个文档有10个字段，那单倒排表就需要数十亿个integer空间，不太现实</p>
<h3 id="6-压缩-Frame-Of-Reference-索引帧"><a href="#6-压缩-Frame-Of-Reference-索引帧" class="headerlink" title="6.压缩-Frame Of Reference 索引帧"></a>6.压缩-Frame Of Reference 索引帧</h3><p>Frame Of Reference主要压缩的就是倒排表posting list</p>
<p>如果有上千万个同学，而世界上只有男&#x2F;女这样两个性别，每个posting list都会有至少百万个文档id。 Elasticsearch是如何有效的对这些文档id压缩的呢?</p>
<p>在进行查询的时候经常会进行组合查询，比如查询同时包含man和woman的文档，那么就需要分别查出包含这两个单词的文档的id，然后取这两个id列表的交集;如果是查包含man或者woman的文档， 那么就需要分别查出posting list然后取并集。为了能够高效的进行交集和并集的操作。为了方便压缩， Elasticsearch要求posting list是有序的(为了提高搜索的性能，再任性的要求也得满足)。同时为了减小存储空间，所有的id都会进行delta编码</p>
<p>举例</p>
<p>比如现在有id列表 [73, 300, 302, 332, 343, 372] ，转化成每一个id相对于前一个id的增量值(第 一个id的前一个id默认是0，增量就是它自己)列表是 [73, 227, 2, 30, 11, 29] 。在这个新的列表里面，所有的id都是小于255的，所以每个id只需要一个字节（8bit）存储</p>
<p>实际上ES会做的更加精细，它会把所有的文档分成很多个block，每个block正好包含256个文档，然后 单独对每个文档进行增量编码，计算出存储这个block里面所有文档最多需要多少位来保存每个id，并 且把这个位数作为头信息(header)放在每个block 的前面。这个技术叫Frame of Reference（索引帧）</p>
<img src="https://static-2w2.pages.dev/post/es-frame.png" alt="image-20230411155345684" style="zoom:50%;" />

<blockquote>
<p>8个二进制位构成一个字节。这种压缩算法的原理就是通过增量，将原来的大数变成小数仅存储增 量值，再精打细算按bit排好队，最后通过字节存储，而不是大大咧咧的尽管是2也是用int(4个字 节)来存储</p>
</blockquote>
<p>在返回结果的时候，其实也并不需要把所有的数据直接解压然后一股脑全部返回，可以直接返回一个迭代器 iterator ，直接通过迭代器的 next 方法逐一取出压缩的id，这样也可以极大的节省计算和内存开销</p>
<p>通过以上的方式可以极大的节省posting list的空间消耗，提高查询性能。不过ES为了提高filter过滤器查询的性能，还做了更多的工作，那就是缓存</p>
<h3 id="7-缓存-Roaring-Bitmaps-咆哮位图"><a href="#7-缓存-Roaring-Bitmaps-咆哮位图" class="headerlink" title="7.缓存-Roaring Bitmaps 咆哮位图"></a>7.缓存-Roaring Bitmaps 咆哮位图</h3><p>ES会缓存频率比较高的filter查询，其中的原理也比较简单，即生成 (fitler, segment数据空间) 和id列表的映射，但是和倒排索引不同，我们只把常用的filter缓存下来而倒排索引是保存所有的，并且 filter缓存应该足够快，不然直接查询不就可以了。ES直接把缓存的filter放到内存里面，映射的posting list放入磁盘中</p>
<blockquote>
<p>ES在filter缓存使用的压缩方式和倒排索引的压缩方式并不相同，filter缓存使用了roaring bitmap的数 据结构，在查询的时候相对于上面的Frame of Reference方式CPU消耗要小，查询效率更高，代价就是需要的存储空间(磁盘)更多。</p>
<p>Roaring Bitmap是由int数组和bitmap这两个数据结构改良过的成果——int数组速度快但是空间消耗大，bitmap相对来说空间消耗小但是不管包含多少文档都需要12.5MB的空间，即使只有一个文件也要 12.5MB的空间，这样实在不划算，所以权衡之后就有了下面的Roaring Bitmap</p>
</blockquote>
<p>Bitmap是一种数据结构，假设有某个posting list: [1,3,4,7,10]<br>对应的bitmap就是:[1,0,1,1,0,0,1,0,0,1]<br>非常直观，用0&#x2F;1表示某个值是否存在，比如10这个值就对应第10位，对应的bit值是1，这样用一 个字节就可以代表8个文档id，旧版本(5.0之前)的Lucene就是用这样的方式来压缩的，但这样的压缩方式仍然不够高效，如果有1亿个文档，那么需要12.5MB的存储空间，这仅仅是对应一个索引字段(我们往往会有很多个索引字段)。于是有人想出了Roaring bitmaps这样更高效的数据结构<br>Bitmap的缺点是存储空间随着文档个数线性增长，Roaring bitmaps需要打破这个魔咒就一定要用到某些指数特性</p>
<ul>
<li>Roaring Bitmap首先会根据每个id的高16位分配id到对应的block里面，比如第一个block里面id应该都是在0到65535之间，第二个block的id在65536和131071之间</li>
<li>对于每一个block里面的数据，根据id数量分成两类<ul>
<li>如果数量小于4096，就是用short数组保存</li>
<li>数量大于等于4096，就使用bitmap保存</li>
</ul>
</li>
</ul>
<blockquote>
<p>即通过文档id的高16位散射到block上，block的结构则由散射过来的id数量决定</p>
</blockquote>
<img src="https://static-2w2.pages.dev/post/es-roaing-bitmap.png" alt="image-20230411160309030" style="zoom:50%;" />

<blockquote>
<p>为什么选择4096作为分界线呢？</p>
<p>因为当数量小于4096的时候，如果用bitmap就需要8kB的空间，而使用2个字节 的数组空间消耗就要少一点。比如只有2048个值，每个值2字节，一共只需要4kB就能保存，但是 bitmap需要8kB</p>
</blockquote>
<h3 id="8-倒排索引实现联合索引"><a href="#8-倒排索引实现联合索引" class="headerlink" title="8.倒排索引实现联合索引"></a>8.倒排索引实现联合索引</h3><p>上面讨论的都是单个索引的流程，那么如何使用倒排索引做联合索引呢？</p>
<p>两种实现方式：跳表或者bitset</p>
<ul>
<li>利用跳表(Skip list)的数据结构快速做“与”运算</li>
<li>利用上面提到的bitset按位“与”</li>
</ul>
<p>首先是跳表，如下</p>
<img src="https://static-2w2.pages.dev/post/es-skiplist.png" alt="image-20230411160623631" style="zoom:50%;" />

<p>将一个有序链表level0，挑出其中几个元素到level1及level2，每个level越往上，选出来的指针元素越少，查找时依次从高level往低查找，比如45，先找到level2的25，最后找到45，查找效率和2叉树的效率相当，但也是用了一定的空间冗余来换取的</p>
<p>假设有下面三个posting list需要联合索引:</p>
<img src="https://static-2w2.pages.dev/post/es-skip-index.png" alt="image-20230411160742751" style="zoom:50%;" />

<p>如果使用跳表，对最短的posting list中的每个id，逐个在另外两个posting list中查找看是否存在，最后得到交集的结果</p>
<p>如果使用bitset(基于bitMap)，就很直观了，直接按位与，得到的结果就是最后的交集</p>
<blockquote>
<p>注意，这是倒排索引实现联合索引的方式，不是说ES就是这样操作的</p>
</blockquote>
<h2 id="四、总结"><a href="#四、总结" class="headerlink" title="四、总结"></a>四、总结</h2><p>**Elasticsearch的索引思路:**将磁盘里的东西尽量搬进内存，减少磁盘随机读取次数(同时也利用磁盘顺序读特性)，结合各种奇技淫巧的压缩算法，用及其苛刻的态度使用内存</p>
<p>所以，对于使用Elasticsearch进行索引时需要注意:</p>
<ul>
<li>不需要索引的字段，一定要明确定义出来，因为默认是自动建索引的</li>
<li>同样的道理，对于String类型的字段，不需要analysis(分词)的也需要明确定义出来，因为默认也是会analysis的</li>
<li>选择有规律的ID很重要，随机性太大的ID(比如java的UUID)不利于查询</li>
</ul>
<p>关于最后一点，个人认为有多个因素:</p>
<ul>
<li>其中一个(也许不是最重要的)因素: 上面看到的压缩算法，都是对Posting list里的大量ID进行压缩的，那如果ID是顺序的，或者是有公共前缀等具有一定规律性的ID，压缩比会比较高;</li>
<li>另外一个因素: 可能是最影响查询性能的，应该是最后通过Posting list里的ID到磁盘中查找Document 信息的那步，因为Elasticsearch是分Segment存储的，根据ID这个大范围的Term定位到Segment的效率直接影响了最后查询的性能，如果ID是有规律的，可以快速跳过不包含该ID的Segment，从而减少不必要的磁盘读次数</li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://yzj.life">zjyan</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://yzj.life/2023/03/26/ElasticSearch/">http://yzj.life/2023/03/26/ElasticSearch/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://yzj.life" target="_blank">春</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/ElasticSearch/">ElasticSearch</a></div><div class="post_share"><div class="social-share" data-image="https://static-2w2.pages.dev/black/9.jpeg" data-sites="wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/03/31/Zookeeper/"><img class="prev-cover" src="https://static-2w2.pages.dev/black/7.jpeg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Zookeeper</div></div></a></div><div class="next-post pull-right"><a href="/2023/03/16/redis%E8%AF%A6%E8%A7%A3%EF%BC%88%E4%B8%89%EF%BC%89/"><img class="next-cover" src="https://static-2w2.pages.dev/black/3.jpeg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">redis详解（三）redis场景与实战</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="giscus-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://static-2w2.pages.dev/imgs/cx.jpeg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">zjyan</div><div class="author-info__description">爱我所爱，尽我所能</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">25</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">19</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/zhijie-yan"><i class="fab fa-github"></i><span>欢迎交流～</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://space.bilibili.com/304087712" target="_blank" title="Bilibili"><i class="fab fa-bilibili"></i></a><a class="social-icon" href="mailto:yan1255015228@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content"><center>我想你一定很忙<br>所以<br>只看前三个字就好了<br></center></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E5%BC%95%E8%A8%80"><span class="toc-text">一、引言</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E4%BB%80%E4%B9%88%E6%98%AF%E6%90%9C%E7%B4%A2%EF%BC%9F"><span class="toc-text">1.什么是搜索？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E6%90%9C%E7%B4%A2"><span class="toc-text">2.如何实现搜索</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-%E4%BC%A0%E7%BB%9F%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-text">2.1 传统数据库</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-%E5%85%A8%E6%96%87%E6%A3%80%E7%B4%A2%E4%B8%8E%E5%80%92%E6%8E%92%E7%B4%A2%E5%BC%95"><span class="toc-text">2.2 全文检索与倒排索引</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-Lucene"><span class="toc-text">2.3 Lucene</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E6%A6%82%E5%BF%B5%E4%BB%8B%E7%BB%8D"><span class="toc-text">二、概念介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E7%AE%80%E4%BB%8B"><span class="toc-text">1.简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E9%80%82%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-text">2.适用场景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E7%89%B9%E7%82%B9"><span class="toc-text">3.特点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5"><span class="toc-text">4.核心概念</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-NRT-Near-Realtime-%E8%BF%91%E5%AE%9E%E6%97%B6"><span class="toc-text">4.1 NRT(Near Realtime):近实时</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-Cluster-%E9%9B%86%E7%BE%A4"><span class="toc-text">4.2 Cluster:集群</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-Node-%E8%8A%82%E7%82%B9"><span class="toc-text">4.3 Node:节点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-4-Index-%E7%B4%A2%E5%BC%95"><span class="toc-text">4.4 Index:索引</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-5-Document-%E6%96%87%E6%A1%A3"><span class="toc-text">4.5 Document:文档</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-6-Field-%E5%AD%97%E6%AE%B5"><span class="toc-text">4.6 Field:字段</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-7-Type-%E7%B1%BB%E5%9E%8B"><span class="toc-text">4.7 Type:类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-8-shard-%E5%88%86%E7%89%87"><span class="toc-text">4.8 shard:分片</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-9-replica-%E5%89%AF%E6%9C%AC"><span class="toc-text">4.9 replica:副本</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-10-Mapping-%E6%98%A0%E5%B0%84"><span class="toc-text">4.10 Mapping:映射</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-11-%E5%AF%B9%E6%AF%94"><span class="toc-text">4.11 对比</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86"><span class="toc-text">三、核心原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%96%87%E4%BB%B6%E5%AD%98%E5%82%A8"><span class="toc-text">1.文件存储</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%80%92%E6%8E%92%E8%A1%A8%E4%B8%8E%E5%88%86%E7%B1%BB%E7%B4%A2%E5%BC%95"><span class="toc-text">2.倒排表与分类索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-Term-Dictionary-%E8%AF%8D%E5%85%B8"><span class="toc-text">3.Term Dictionary(词典)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-Term-Index-%E8%AF%8D%E5%85%B8%E7%B4%A2%E5%BC%95%EF%BC%89"><span class="toc-text">4.Term Index(词典索引）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-FST"><span class="toc-text">5.FST</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-%E5%8E%8B%E7%BC%A9-Frame-Of-Reference-%E7%B4%A2%E5%BC%95%E5%B8%A7"><span class="toc-text">6.压缩-Frame Of Reference 索引帧</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-%E7%BC%93%E5%AD%98-Roaring-Bitmaps-%E5%92%86%E5%93%AE%E4%BD%8D%E5%9B%BE"><span class="toc-text">7.缓存-Roaring Bitmaps 咆哮位图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-%E5%80%92%E6%8E%92%E7%B4%A2%E5%BC%95%E5%AE%9E%E7%8E%B0%E8%81%94%E5%90%88%E7%B4%A2%E5%BC%95"><span class="toc-text">8.倒排索引实现联合索引</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E6%80%BB%E7%BB%93"><span class="toc-text">四、总结</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/04/04/MQ%E4%B9%8BKafka/" title="消息中间件之Kafka"><img src="https://static-2w2.pages.dev/black/10.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="消息中间件之Kafka"/></a><div class="content"><a class="title" href="/2023/04/04/MQ%E4%B9%8BKafka/" title="消息中间件之Kafka">消息中间件之Kafka</a><time datetime="2023-04-04T11:45:59.000Z" title="发表于 2023-04-04 19:45:59">2023-04-04</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/04/03/MQ%E4%B9%8BRocketMQ/" title="消息中间件之RocketMQ"><img src="https://static-2w2.pages.dev/black/4.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="消息中间件之RocketMQ"/></a><div class="content"><a class="title" href="/2023/04/03/MQ%E4%B9%8BRocketMQ/" title="消息中间件之RocketMQ">消息中间件之RocketMQ</a><time datetime="2023-04-03T11:45:46.000Z" title="发表于 2023-04-03 19:45:46">2023-04-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/04/02/MQ%E4%B9%8BRabbitMQ/" title="消息中间件之RabbitMQ"><img src="https://static-2w2.pages.dev/black/6.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="消息中间件之RabbitMQ"/></a><div class="content"><a class="title" href="/2023/04/02/MQ%E4%B9%8BRabbitMQ/" title="消息中间件之RabbitMQ">消息中间件之RabbitMQ</a><time datetime="2023-04-02T11:45:31.000Z" title="发表于 2023-04-02 19:45:31">2023-04-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/03/31/Zookeeper/" title="Zookeeper"><img src="https://static-2w2.pages.dev/black/7.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Zookeeper"/></a><div class="content"><a class="title" href="/2023/03/31/Zookeeper/" title="Zookeeper">Zookeeper</a><time datetime="2023-03-31T01:29:00.000Z" title="发表于 2023-03-31 09:29:00">2023-03-31</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/03/26/ElasticSearch/" title="ElasticSearch"><img src="https://static-2w2.pages.dev/black/9.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ElasticSearch"/></a><div class="content"><a class="title" href="/2023/03/26/ElasticSearch/" title="ElasticSearch">ElasticSearch</a><time datetime="2023-03-26T01:40:06.000Z" title="发表于 2023-03-26 09:40:06">2023-03-26</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://static-2w2.pages.dev/black/9.jpeg')"><div id="footer-wrap"><div class="copyright">&copy;2022 - 2023 By zjyan</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>function loadGiscus () {
  let nowTheme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'light'

  const config = Object.assign({
    src: 'https://giscus.app/client.js',
    'data-repo': 'zhijie-yan/Giscus',
    'data-repo-id': 'R_kgDOJSiR1Q',
    'data-category-id': 'DIC_kwDOJSiR1c4CVhQv',
    'data-mapping': 'pathname',
    'data-theme': nowTheme,
    'data-reactions-enabled': '1',
    crossorigin: 'anonymous',
    async: true
  },null)

  let ele = document.createElement('script')
  for (let key in config) {
    ele.setAttribute(key, config[key])
  }
  document.getElementById('giscus-wrap').insertAdjacentElement('afterbegin',ele)
}

function changeGiscusTheme () {
  const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'light'

  function sendMessage(message) {
    const iframe = document.querySelector('iframe.giscus-frame');
    if (!iframe) return;
    iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
  }

  sendMessage({
    setConfig: {
      theme: theme
    }
  });
}

if ('Giscus' === 'Giscus' || !false) {
  if (false) btf.loadComment(document.getElementById('giscus-wrap'), loadGiscus)
  else loadGiscus()
} else {
  function loadOtherComment () {
    loadGiscus()
  }
}</script></div><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["link[rel=\"canonical\"]","meta[property=\"og:image\"]","meta[property=\"og:title\"]","meta[property=\"og:url\"]","head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/wanko.model.json"},"display":{"position":"laft","width":150,"height":300},"mobile":{"show":true},"algolia":{"indexName":"hexo","applicationID":"T31GFL5LNX","apiKey":"180a4925ad0cc4ca01c1efcbe8b6ec59","fields":["title","content","url"],"debug":false,"concurrent":2},"log":false});</script></body></html>